{% extends "base.html" %}
{% set active_page = "job-tracker" %}

{% block title %}Job Tracker Board{% endblock %}

{% block content %}
<div class="flex-1 flex flex-col">
  <!-- HEADER + BUTTON -->
  <header class="px-6 py-4 bg-indigo-100 border-b border-gray-200 flex justify-between items-center">
    <h1 class="text-xl font-semibold text-indigo-900">Your Job Tracker</h1>
    <button id="addBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
      + Add Application
    </button>
  </header>

  <!-- CONTENT AREA -->
  <main class="flex-1 p-6 overflow-y-auto">
    <div class="overflow-x-auto space-y-6">

      <!-- SCROLLABLE TABLE WITH ADD ROW BUTTON -->
      <div class="border border-gray-300 rounded-lg overflow-hidden">
        <div class="overflow-y-auto" style="max-height: 500px;">
          <table id="jobTable" class="table-fixed w-full border-collapse">
            <thead class="bg-indigo-100 text-indigo-800">
              <tr>
                <th class="border border-gray-300 p-2">Saved</th>
                <th class="border border-gray-300 p-2">Applied</th>
                <th class="border border-gray-300 p-2">Screen</th>
                <th class="border border-gray-300 p-2">Interviewing</th>
                <th class="border border-gray-300 p-2">Offer</th>
                <th class="border border-gray-300 p-2">Accepted</th>
                <th class="border border-gray-300 p-2">Archived</th>
                <th class="border border-gray-300 p-2">Discontinued</th>
              </tr>
            </thead>
            <tbody class="text-center" id="tableBody">
              {% for i in range(10) %}
              <tr>
                {% for column in ["Saved", "Applied", "Screen", "Interviewing", "Offer", "Accepted", "Archived", "Discontinued"] %}
                <td class="border border-gray-300 p-6"></td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="bg-gray-100 p-3 flex justify-center">
          <button id="addRowBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            + Add Row
          </button>
        </div>
      </div>

      <!-- ORIGINAL DRAGGABLE COLUMNS BELOW -->
      <div id="columns" class="flex gap-4 min-w-max mt-6"></div>

    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-none shadow-lg p-8 w-full max-w-3xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-indigo-900">Add New Job</h2>
        <button id="closeModal" class="text-gray-600 hover:text-red-500 text-2xl">&times;</button>
      </div>
      <form id="jobForm" class="grid grid-cols-2 gap-6">
        <!-- FORM FIELDS -->
        <div class="flex flex-col">
          <label for="title" class="text-gray-700 mb-2 text-sm font-medium">Position Title *</label>
          <input id="title" class="input-style" required placeholder="Software Engineer"/>
        </div>
        <div class="flex flex-col">
          <label for="company" class="text-gray-700 mb-2 text-sm font-medium">Company *</label>
          <input id="company" class="input-style" required placeholder="Google"/>
        </div>
        <div class="flex flex-col">
          <label for="location" class="text-gray-700 mb-2 text-sm font-medium">Location *</label>
          <input id="location" class="input-style" required placeholder="Sydney"/>
        </div>
        <div class="flex flex-col">
          <label for="jobType" class="text-gray-700 mb-2 text-sm font-medium">Job Type *</label>
          <select id="jobType" class="input-style" required>
            <option>Internship</option>
            <option>Graduate Role</option>
            <option>Full-Time</option>
            <option>Part-Time</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label for="status" class="text-gray-700 mb-2 text-sm font-medium">Job Status *</label>
          <select id="status" class="input-style" required>
            <option>Saved</option>
            <option>Applied</option>
            <option>Screen</option>
            <option>Interviewing</option>
            <option>Offer</option>
            <option>Accepted</option>
            <option>Archived</option>
            <option>Discontinued</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label for="resume" class="text-gray-700 mb-2 text-sm font-medium">Resume Uploaded</label>
          <select id="resume" class="input-style">
            <option>Default Resume</option>
            <option>Resume 1</option>
            <option>Resume 2</option>
          </select>
        </div>

        <!-- ACTIONS -->
        <div class="col-span-2 flex justify-end space-x-4 mt-6">
          <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-none">
            Cancel
          </button>
          <button type="submit" class="px-6 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-none">
            Add
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const columns = ["Saved","Applied","Screen","Interviewing","Offer","Accepted","Archived","Discontinued"];
  let jobs = [];

  function renderColumns() {
    $("#columns").empty();
    columns.forEach(col => {
      $("#columns").append(`
        <div class="w-64 bg-white border p-4 rounded shadow-sm"
             ondragover="event.preventDefault()"
             ondrop="onDrop(event,'${col}')">
          <h2 class="font-semibold mb-2">${col}</h2>
          <div id="${col}-list" class="space-y-2"></div>
        </div>`);
    });
    renderJobs();
  }

  function renderJobs() {
    columns.forEach(c => $(`#${c}-list`).empty());
    jobs.forEach((job,i) => {
      $(`#${job.status}-list`).append(`
        <div class="bg-white border p-3 rounded shadow cursor-move"
             draggable="true"
             ondragstart="onDragStart(event,${i})">
          <p class="font-medium">${job.title}</p>
          <p class="text-sm text-gray-600">${job.company}</p>
          <p class="text-sm text-gray-400">${job.location}</p>
        </div>`);
    });
  }

  function onDragStart(e,i){ e.originalEvent.dataTransfer.setData("jobIndex",i); }
  function onDrop(e,col){
    const idx = e.dataTransfer.getData("jobIndex");
    jobs[idx].status = col;
    renderJobs();
  }

  function addRow() {
    const tableBody = document.getElementById('tableBody');
    const newRow = document.createElement('tr');
    for (let i = 0; i < columns.length; i++) {
      const td = document.createElement('td');
      td.className = "border border-gray-300 p-6";
      newRow.appendChild(td);
    }
    tableBody.appendChild(newRow);
  }

  $(function(){
    renderColumns();
    $("#addBtn").click(()=>$("#modal").removeClass("hidden").addClass("flex"));
    $("#closeModal,#cancelBtn").click(()=>$("#modal").addClass("hidden"));
    $("#jobForm").submit(e=>{
      e.preventDefault();
      jobs.push({
        title:$("#title").val(),
        company:$("#company").val(),
        location:$("#location").val(),
        jobType:$("#jobType").val(),
        status:$("#status").val(),
        resume:$("#resume").val()
      });
      renderJobs();
      $("#modal").addClass("hidden");
      e.target.reset();
    });

    $("#addRowBtn").click(() => {
      addRow();
    });
  });
</script>
{% endblock %}