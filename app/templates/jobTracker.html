{% extends "base.html" %}
{% set active_page = "job-tracker" %}
{% block title %}Job Tracker Board{% endblock %}
{% block content %}
<div class="flex-1 flex flex-col overflow-hidden">
  <!-- HEADER -->
  <header class="px-6 py-4 bg-indigo-100 border-b border-gray-200 flex justify-between items-center">
    <h1 class="text-xl font-semibold text-indigo-900">Your Job Tracker</h1>
    <button id="openModal" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
      + Add Application
    </button>
  </header>

  <!-- SEARCH BAR -->
  <div class="p-4 flex flex-wrap gap-4 bg-white shadow-md rounded-lg mb-6">
    <input type="text" id="searchInput" placeholder="Search for roles or companies" class="border rounded-lg px-4 py-2 flex-1" />
    <input type="date" class="border rounded-lg px-4 py-2" />
    <input type="date" class="border rounded-lg px-4 py-2" />
    <select class="border rounded-lg px-4 py-2">
      <option>Job Type</option>
    </select>
    <select class="border rounded-lg px-4 py-2">
      <option>Status</option>
    </select>
  </div>

  <!-- TABLE -->
  <main class="flex-1 overflow-x-auto p-4 bg-white rounded-lg shadow-md">
    <table class="min-w-full table-fixed">
      <thead class="bg-indigo-100">
        <tr>
          {% for col in ["Saved", "Applied", "Screen", "Interviewing", "Offer", "Accepted", "Archived", "Discontinued"] %}
            <th class="px-4 py-2 text-sm text-gray-600">{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr>
          {% for column in ["Saved", "Applied", "Screen", "Interviewing", "Offer", "Accepted", "Archived", "Discontinued"] %}
          <td id="{{ column }}" ondragover="event.preventDefault()" ondrop="onDrop(event, '{{ column }}')" class="border h-40 align-top p-2">
            {% for job in grouped[column] %}
              <div id="job-{{ job.id }}" draggable="true" ondragstart="onDragStart(event)" class="bg-indigo-50 p-4 rounded-lg shadow mb-2 relative cursor-move">
                <button onclick="deleteJob('job-{{ job.id }}')" class="absolute top-1 right-2 text-red-500 hover:text-red-700 text-lg font-bold">&times;</button>
                <p class="font-semibold text-indigo-800">{{ job.company }}</p>
                <p class="text-gray-600">{{ job.title }}</p>
                {% if job.location %}
                <p class="text-xs text-gray-500 mt-1">üìç {{ job.location }}</p>
                {% endif %}
                {% if job.job_type %}
                <p class="text-xs text-gray-500">üíº {{ job.job_type }}</p>
                {% endif %}
                {% if job.closing_date %}
                <p class="text-xs text-red-600 mt-1">Closes: {{ job.closing_date.strftime('%d %b %Y') }}</p>
                {% endif %}
                <p class="text-xs text-gray-400 mt-1">Added: {{ job.date_applied.strftime('%Y-%m-%d') }}</p>
                <!-- SHARE BUTTON -->
                <button onclick="openShareModal('{{ job.id }}')"
                  class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1 rounded">
                  Share
                </button>
              </div>
            {% endfor %}
          </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </main>

  <!-- Add Application Modal -->
  <div id="add-application-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Add New Application</h3>
        <form method="post" action="{{ url_for('add_application') }}">
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="title">
              Job Title *
            </label>
            <input type="text" name="title" required
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
          </div>
          
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="company">
              Company *
            </label>
            <input type="text" name="company" required
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="location">
              Location
            </label>
            <input type="text" name="location"
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="job_type">
              Job Type
            </label>
            <select name="job_type" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
              <option value="">Select Type</option>
              <option value="Internships">Internship</option>
              <option value="Graduate-Jobs">Graduate Job</option>
              <option value="Scholarships">Scholarship</option>
              <option value="Clerkships">Clerkship</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="closing_date">
              Closing Date
            </label>
            <input type="date" name="closing_date"
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="status">
              Status *
            </label>
            <select name="status" required class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
              <option value="Saved">Saved</option>
              <option value="Applied">Applied</option>
              <option value="Screen">Screen</option>
              <option value="Interviewing">Interviewing</option>
              <option value="Offer">Offer</option>
              <option value="Accepted">Accepted</option>
              <option value="Archived">Archived</option>
              <option value="Discontinued">Discontinued</option>
            </select>
          </div>

          <div class="flex items-center justify-between mt-6">
            <button type="button" onclick="closeModal()"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
              Cancel
            </button>
            <button type="submit"
                    class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
              Add Application
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SHARE MODAL -->
  <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg w-full max-w-md relative">
      <button onclick="closeShareModal()" class="absolute top-2 right-3 text-gray-500 hover:text-black text-xl font-bold">&times;</button>
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Share Application</h2>
      <form method="POST" id="shareForm">
        <select name="friend_id" class="w-full border px-3 py-2 rounded mb-4" required>
          {% for friend in user.friends %}
            <option value="{{ friend.id }}">{{ friend.name }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-4 py-2 rounded w-full">
          Share Application
        </button>
      </form>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
const modal = document.getElementById('add-application-modal');
document.getElementById('openModal').onclick = () => modal.classList.remove('hidden');

function onDragStart(event) {
  event.dataTransfer.setData("text/plain", event.target.id);
}

function onDrop(event, columnId) {
  const id = event.dataTransfer.getData("text/plain");
  const jobBox = document.getElementById(id);
  document.getElementById(columnId).appendChild(jobBox);
  const jobId = id.replace("job-", "");
  fetch("/update-job-status", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ job_id: jobId, new_status: columnId })
  }).then(response => {
    if (!response.ok) console.error("Failed to update job status.");
  });
}

function deleteJob(id) {
  const jobId = id.replace('job-', '');
  fetch(`/delete-application/${jobId}`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Failed to delete job');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      const job = document.getElementById(id);
      if (job) job.remove();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to delete job. Please try again.');
  });
}

const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input", function() {
  const filter = this.value.toLowerCase();
  const jobs = document.querySelectorAll("td > div");
  jobs.forEach(job => {
    const text = job.innerText.toLowerCase();
    job.parentElement.style.display = text.includes(filter) ? "" : "none";
  });
});

// SHARE MODAL SCRIPT
let currentAppId = null;
function openShareModal(appId) {
  currentAppId = appId;
  document.getElementById('shareModal').classList.remove('hidden');
}
function closeShareModal() {
  document.getElementById('shareModal').classList.add('hidden');
  currentAppId = null;
}
document.getElementById('shareForm').onsubmit = function(e) {
  e.preventDefault();
  const friendId = this.friend_id.value;
  fetch(`/share-application/${currentAppId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `friend_id=${friendId}`
  }).then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    } else {
      closeShareModal();
    }
  });
};

function openModal() {
  document.getElementById('add-application-modal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('add-application-modal').classList.add('hidden');
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('add-application-modal');
  if (event.target == modal) {
    closeModal();
  }
}
</script>
{% endblock %}
