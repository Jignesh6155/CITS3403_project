{% extends "base.html" %}
{% set active_page = "job-tracker" %}

{% block title %}Job Tracker Board{% endblock %}

{% block content %}
<div class="flex-1 flex flex-col overflow-hidden">
  <!-- HEADER -->
  <header class="px-6 py-4 bg-indigo-100 border-b border-gray-200 flex justify-between items-center">
    <h1 class="text-xl font-semibold text-indigo-900">Your Job Tracker</h1>
    <button id="openModal" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
      + Add Application
    </button>
  </header>

  <!-- SEARCH BAR -->
  <div class="p-4 flex flex-wrap gap-4 bg-white shadow-md rounded-lg mb-6">
    <input type="text" id="searchInput" placeholder="Search for roles or companies" class="border rounded-lg px-4 py-2 flex-1" />
    <input type="date" class="border rounded-lg px-4 py-2" />
    <input type="date" class="border rounded-lg px-4 py-2" />
    <select class="border rounded-lg px-4 py-2">
      <option>Job Type</option>
    </select>
    <select class="border rounded-lg px-4 py-2">
      <option>Status</option>
    </select>
  </div>

  <!-- TABLE -->
  <main class="flex-1 overflow-x-auto p-4 bg-white rounded-lg shadow-md">
    <table class="min-w-full table-fixed">
      <thead class="bg-indigo-100">
        <tr>
          <th class="px-4 py-2 text-sm text-gray-600">Saved</th>
          <th class="px-4 py-2 text-sm text-gray-600">Applied</th>
          <th class="px-4 py-2 text-sm text-gray-600">Screen</th>
          <th class="px-4 py-2 text-sm text-gray-600">Interviewing</th>
          <th class="px-4 py-2 text-sm text-gray-600">Offer</th>
          <th class="px-4 py-2 text-sm text-gray-600">Accepted</th>
          <th class="px-4 py-2 text-sm text-gray-600">Archived</th>
          <th class="px-4 py-2 text-sm text-gray-600">Discontinued</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          {% for column in ["Saved", "Applied", "Screen", "Interviewing", "Offer", "Accepted", "Archived", "Discontinued"] %}
          <td id="{{ column }}" ondragover="event.preventDefault()" ondrop="onDrop(event, '{{ column }}')" class="border h-40 align-top p-2">
            {% for job in grouped[column] %}
              <div id="job-{{ job.id }}" draggable="true" ondragstart="onDragStart(event)" class="bg-indigo-50 p-4 rounded-lg shadow mb-2 relative cursor-move">
                <button onclick="deleteJob('job-{{ job.id }}')" class="absolute top-1 right-2 text-red-500 hover:text-red-700 text-lg font-bold">&times;</button>
                <p class="font-semibold text-indigo-800">{{ job.company }}</p>
                <p class="text-gray-600">{{ job.title }}</p>
                <p class="text-gray-400 text-sm">{{ job.date_applied.strftime('%Y-%m-%d') }}</p>
                <button onclick="openShareModal('{{ job.id }}')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded">
    Share
  </button>
              </div>
            {% endfor %}
          </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
    <div class="bg-white p-8 rounded-lg w-full max-w-md relative">
      <button id="closeModal" class="absolute top-4 right-6 text-gray-500 hover:text-black text-2xl">&times;</button>
      <h2 class="text-2xl font-bold text-indigo-900 mb-6 text-center">Add Application</h2>
      <form method="POST" action="{{ url_for('add_application') }}" class="flex flex-col gap-4">
        <input id="companyName" name="company" type="text" placeholder="Company Name" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" />
        <input id="jobTitle" name="title" type="text" placeholder="Job Title" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" />
        <input id="dateApplied" name="date_applied" type="date" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" />
        <select id="status" name="status" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300">
          <option value="" disabled selected>Select Status</option>
          <option>Saved</option>
          <option>Applied</option>
          <option>Screen</option>
          <option>Interviewing</option>
          <option>Offer</option>
          <option>Accepted</option>
          <option>Archived</option>
          <option>Discontinued</option>
        </select>
        <button type="submit" class="bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
          Add
        </button>
      </form>
    </div>
  </div>
</div>

<div id="shareModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white p-8 rounded-lg w-full max-w-md relative">
    <button onclick="closeShareModal()" class="absolute top-4 right-6 text-gray-500 hover:text-black text-2xl">&times;</button>
    <h2 class="text-2xl font-bold text-indigo-900 mb-6 text-center">Share Application</h2>
    <form id="shareForm" method="POST" class="flex flex-col gap-4">
      <input type="hidden" id="shareAppId" name="app_id">
      <select id="shareFriendId" name="friend_id" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300">
        <option value="" disabled selected>Select Friend</option>
        {% for friend in current_user.friends %}
          <option value="{{ friend.id }}">{{ friend.name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
        Share
      </button>
    </form>
  </div>
</div>
</div>  

{% endblock %}

{% block scripts %}
<script>
// OPEN/CLOSE MODAL
const modal = document.getElementById('modal');
document.getElementById('openModal').onclick = () => modal.classList.remove('hidden');
document.getElementById('closeModal').onclick = () => modal.classList.add('hidden');
window.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden'); }

// DRAG LOGIC
function onDragStart(event) {
  event.dataTransfer.setData("text/plain", event.target.id);
}
function onDrop(event, columnId) {
  const id = event.dataTransfer.getData("text/plain");
  const jobBox = document.getElementById(id);
  document.getElementById(columnId).appendChild(jobBox);

  // Persist the new status to the backend
  const jobId = id.replace("job-", ""); // assumes job id is in DOM id (e.g., job-123)
  
  fetch("/update-job-status", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      job_id: jobId,
      new_status: columnId,
    }),
  }).then((response) => {
    if (!response.ok) {
      console.error("Failed to update job status.");
    }
  });
}


// DELETE JOB
function deleteJob(id) {
  const job = document.getElementById(id);
  if (job) {
    job.remove();
  }
}

// SUBMIT FORM
document.getElementById('applicationForm').onsubmit = function(e) {
  e.preventDefault();

  const company = document.getElementById('companyName').value;
  const title = document.getElementById('jobTitle').value;
  const date = document.getElementById('dateApplied').value;
  const status = document.getElementById('status').value;

  const newId = 'job-' + Date.now();
  const div = document.createElement('div');
  div.id = newId;
  div.setAttribute('draggable', 'true');
  div.setAttribute('ondragstart', 'onDragStart(event)');
  div.className = "bg-indigo-50 p-4 rounded-lg shadow mb-2 relative cursor-move";

  div.innerHTML = 
    `<button onclick="deleteJob('${newId}')" class="absolute top-1 right-2 text-red-500 hover:text-red-700 text-lg font-bold">&times;</button>
    <p class="font-semibold text-indigo-800">${company}</p>
    <p class="text-gray-600">${title}</p>
    <p class="text-gray-400 text-sm">${date}</p>`;

  document.getElementById(status).appendChild(div);
  modal.classList.add('hidden');
  this.reset();
};

// SIMPLE SEARCH
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input", function() {
  const filter = this.value.toLowerCase();
  const jobs = document.querySelectorAll("td > div");

  jobs.forEach(job => {
    const text = job.innerText.toLowerCase();
    job.parentElement.style.display = text.includes(filter) ? "" : "none";
  });
});
</script>

<script>
// SHARE APPLICATION MODAL
const shareModal = document.getElementById('shareModal');
const shareForm = document.getElementById('shareForm');

function openShareModal(appId) {
  document.getElementById('shareAppId').value = appId;
  shareModal.classList.remove('hidden');
}

function closeShareModal() {
  shareModal.classList.add('hidden');
}

shareForm.onsubmit = function(e) {
  e.preventDefault();
  const appId = document.getElementById('shareAppId').value;
  const friendId = document.getElementById('shareFriendId').value;
  
  fetch(`/share-application/${appId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `friend_id=${friendId}`
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to share application');
  });
  
  closeShareModal();
};

// Update the window.onclick function to handle both modals
window.onclick = function(e) {
  if (e.target === modal) {
    modal.classList.add('hidden');
  }
  if (e.target === shareModal) {
    closeShareModal();
  }
}
</script>
{% endblock %}
