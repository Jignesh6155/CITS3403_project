{% extends "base.html" %}
{% set active_page = "job-search" %}

{% block title %}Job Search{% endblock %}

{% block content %}
<header class="px-6 py-4 bg-indigo-100 border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-xl font-semibold text-indigo-900">Career Explorer</h1>
  <div class="flex gap-4 items-center">
    {% include 'notifications.html' %}
  <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
</div>
</header>

<div class="flex-1 overflow-auto">
  <main class="flex-1 grid grid-cols-1 xl:grid-cols-3 gap-6 p-6">

        <!-- Resume Upload and Analysis -->
        <section class="bg-white border border-gray-200 p-6 shadow rounded-lg flex flex-col max-h-[calc(100vh-120px)]">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">Search with Resume</h2>
          <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="resume-upload-form">
            <div id="resume-drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center text-center bg-gray-50 hover:border-indigo-400 transition cursor-pointer">
              <i data-lucide="upload-cloud" class="w-10 h-10 text-indigo-400 mb-3"></i>
              <p class="text-sm text-gray-600 font-medium">Click to upload or drag and drop</p>
              <p class="text-xs text-gray-400 mt-1">PDF, DOC, DOCX (Max 25MB)</p>
              <input type="file" name="resume" id="resume-input" accept=".pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/pdf" class="mt-2" style="display:none;" />
              <span id="resume-filename" class="text-xs text-gray-500 mt-2"></span>
            </div>
            <button type="submit" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">Analyse</button>
          </form>
    
          <!-- Keywords -->
          <div class="mt-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Keywords Found:</h3>
            <div class="flex flex-wrap gap-2 text-sm">
              {% if resume_keywords %}
                {% for kw in resume_keywords %}
                  <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">{{ kw }}</span>
                {% endfor %}
              {% else %}
                <span class="text-gray-400">No keywords found.</span>
              {% endif %}
            </div>
          </div>

          <!-- Suggested Jobs -->
          <div class="mt-6 flex flex-col flex-grow overflow-hidden">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex-shrink-0">Suggested Jobs:</h3>
            <div class="flex-grow overflow-y-auto pr-1">
              <ul class="space-y-3 text-sm">
                {% if suggested_jobs %}
                  {% for job in suggested_jobs %}
                    <li class="flex items-center gap-2 bg-indigo-50 p-3 rounded-md">
                      <i data-lucide="briefcase" class="w-5 h-5 text-indigo-600"></i>
                      <span>{{ job.title }}{% if job.company %} @ {{ job.company }}{% endif %}</span>
                      <a href="{{ job.link }}" target="_blank" class="ml-auto text-indigo-600 hover:underline text-xs">View</a>
                    </li>
                  {% endfor %}
                {% else %}
                  <li class="text-gray-400">No suggested jobs found.</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </section>
    
    <!-- Job Search with Filters -->
    <section class="bg-white border border-gray-200 p-6 shadow rounded-lg xl:col-span-2">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Search Jobs</h2>
      <div class="flex items-center gap-2 mb-4">
        <!-- Input gets 7/8 -->
        <input type="text"
               placeholder="Search for roles, companies, or locations"
               class="flex-[7] px-4 py-2 border rounded-md">

        <!-- Button gets 1/8 -->
        <button id="start-scraping-btn"
                class="flex-[1] px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 whitespace-nowrap">
          Search Web
        </button>
      
        <!-- Loader stays as is -->
        <div id="scraping-loader" class="hidden ml-2">
          <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 
                     5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 
                     5.824 3 7.938l3-2.647z">
            </path>
          </svg>
        </div>
      </div>
      
      <!-- Filters Section with Reset and Info Icons -->
      <div class="flex flex-wrap items-center gap-3 mb-6">

        <!-- Location Dropdown -->
        <select class="border rounded-md px-3 py-2" data-type="location">
          <option>Location</option>
          <option>Perth</option>
          <option>Sydney</option>
          <option>Melbourne</option>
          <option>Remote</option>
          <option>Hong-Kong</option>
        </select>

        <!-- Opportunity Type Dropdown -->
        <select class="border rounded-md px-3 py-2" data-type="jobtype">
          <option>Opportunity Type</option>
          <option>Internships</option>
          <option>Graduate-Jobs</option>
          <option>Scholarships</option>
          <option>Clerkships</option>
        </select>

        <!-- Category Dropdown -->
        <select class="border rounded-md px-3 py-2" data-type="category">
          <option>Category</option>
          <option>accounting</option>
          <option>actuarial-studies</option>
          <option>administration</option>
          <option>agriculture</option>
          <option>architecture</option>
          <option>arts-and-humanities</option>
          <option>aviation</option>
          <option>banking-and-finance</option>
          <option>business-and-commerce</option>
          <option>communications</option>
          <option>compliance</option>
          <option>computer-science</option>
          <option>construction</option>
          <option>consulting</option>
          <option>customer-service</option>
          <option>cyber-security</option>
          <option>data-science-and-analytics</option>
          <option>defence</option>
          <option>design-and-user-experience</option>
          <option>economics</option>
          <option>education</option>
          <option>engineering</option>
          <option>engineering-aerospace-aeronautical</option>
          <option>engineering-chemical-processing</option>
          <option>engineering-civil-structural</option>
          <option>engineering-electrical</option>
          <option>engineering-environmental</option>
          <option>engineering-geotechnical</option>
          <option>engineering-mechanical</option>
          <option>engineering-mechatronics</option>
          <option>engineering-mining</option>
          <option>engineering-petroleum</option>
          <option>engineering-software</option>
          <option>environment</option>
          <option>exercise-physiology</option>
          <option>fast-moving-consumer-goods</option>
          <option>food-technology</option>
          <option>funds-management</option>
          <option>geology</option>
          <option>government</option>
          <option>health</option>
          <option>health-policy-and-administration</option>
          <option>horticulture</option>
          <option>hospitality-sports-and-tourism</option>
          <option>human-resources</option>
          <option>industrial-design</option>
          <option>information-systems</option>
          <option>information-technology</option>
          <option>insurance</option>
          <option>intelligence</option>
          <option>investment-banking</option>
          <option>journalism</option>
          <option>law</option>
          <option>logistics-and-supply-chain</option>
          <option>management</option>
          <option>marine-biology</option>
          <option>marketing-and-sales</option>
          <option>mathematics</option>
          <option>media-and-advertising</option>
          <option>medical-and-biomedical-science</option>
          <option>medicine</option>
          <option>mining-oil-and-gas</option>
          <option>nursing-and-midwifery</option>
          <option>operations</option>
          <option>pharmacy-and-pharmacology</option>
          <option>physics</option>
          <option>pphysio-and-occupational-therapy</option>
          <option>planning-and-surveying</option>
          <option>procurement</option>
          <option>project-management</option>
          <option>property</option>
          <option>psychology-and-counselling</option>
          <option>radiography-and-medical-imaging</option>
          <option>recruitment</option>
          <option>research-and-development</option>
          <option>retail</option>
          <option>science</option>
          <option>speech-pathology</option>
          <option>statistics</option>
          <option>telecommunications</option>
          <option>transport</option>
          <option>utilities</option>
        </select>

        <!-- Reset Filters Button -->
        <button id="reset-filters" class="text-gray-500 hover:text-indigo-600 transition-colors" title="Reset Filters">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
        </button>

        <!-- Info Icon with Tooltip -->
        <div class="relative flex items-center group">
          <button type="button" aria-label="Help">
            <svg class="w-5 h-5 text-gray-400 hover:text-indigo-600 transition"
                xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M12 20.5A8.5 8.5 0 103.5 12 8.5 8.5 0 0012 20.5z" />
            </svg>
          </button>

          <!-- Tooltip on Hover -->
          <div class="absolute hidden group-hover:block bg-white border border-gray-300 text-sm text-gray-700 shadow-lg rounded-md p-3 w-64 top-7 left-0 z-50">
            <strong class="block mb-1 text-indigo-700">Using Job Filters</strong>
            Use the dropdowns and search bar to filter jobs by <strong>Location</strong>, <strong>Opportunity Type</strong>, or <strong>Category</strong>.
            <br><br>
            Click <strong>Search Web</strong> to scrape the internet for matching listings using your filters.
            <strong>Be patient</strong>, this may take a moment. Note you <strong>don't have to stay</strong> on this page after initiating the search.
          </div>
        </div>

      </div>


      <!-- Scraped Jobs Results -->
      <div class="mt-8">
        <h3 class="text-sm font-semibold text-indigo-700 mb-2"></h3>
        <div id="scraped-jobs-window" style="max-height: calc(100vh - 350px); overflow-y: auto;">
          <ul id="scraped-jobs-list" class="space-y-4 text-sm">
            <!-- JS will populate this -->
          </ul>
        </div>
      </div>
    </section>

  </main>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables and constants
const PAGE_SIZE = 10;
let currentPage = 1;
let hasMore = true;
let jobs = [];
let isScrapingActive = false;

// Add these style classes at the start of your script
const FILTER_STYLES = {
  location: {
    active: 'bg-blue-50 text-blue-800 border-blue-300',
    hover: 'hover:bg-blue-100'
  },
  jobtype: {
    active: 'bg-green-50 text-green-800 border-green-300',
    hover: 'hover:bg-green-100'
  },
  category: {
    active: 'bg-purple-50 text-purple-800 border-purple-300',
    hover: 'hover:bg-purple-100'
  }
};

// Add this function before the DOMContentLoaded event listener
function setSelectValue(selectId, value) {
  // Find the select element by its data-type attribute
  const select = document.querySelector(`select[data-type="${selectId}"]`);
  if (select) {
    // Find the matching option (case-insensitive)
    const options = Array.from(select.options);
    const option = options.find(opt => 
      opt.value.toLowerCase() === value.toLowerCase() ||
      opt.text.toLowerCase() === value.toLowerCase()
    );
    
    if (option) {
      select.value = option.value;
      select.dispatchEvent(new Event('change'));
    }
  }
}

// Add the saveJob function at global scope
function saveJob(jobData) {
  fetch('/add-application', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      title: jobData.title,
      company: jobData.company,
      location: jobData.tags?.location || '',
      job_type: jobData.tags?.jobtype || '',
      closing_date: jobData.closing_date,
      status: 'Saved',
      date_applied: new Date().toISOString().split('T')[0]
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showToast('Job saved successfully!', 'success');
    } else {
      throw new Error(data.error || 'Failed to save job');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast(error.message || 'Failed to save job', 'error');
  });
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-opacity duration-300`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
  // Get UI elements
  const searchInput = document.querySelector('input[placeholder="Search for roles, companies, or locations"]');
  const searchButton = document.getElementById('start-scraping-btn');
  const scrapingLoader = document.getElementById('scraping-loader');
  const locationSelect = document.querySelectorAll('select')[0];
  const typeSelect = document.querySelectorAll('select')[1];
  const categorySelect = document.querySelectorAll('select')[2];
  const jobsList = document.getElementById('scraped-jobs-list');
  const jobsWindow = document.getElementById('scraped-jobs-window');

  // Update the select elements' base styles
  locationSelect.className = `border rounded-md px-3 py-2 ${FILTER_STYLES.location.hover}`;
  typeSelect.className = `border rounded-md px-3 py-2 ${FILTER_STYLES.jobtype.hover}`;
  categorySelect.className = `border rounded-md px-3 py-2 ${FILTER_STYLES.category.hover}`;

  // Update the select elements to include data-type attributes
  locationSelect.setAttribute('data-type', 'location');
  typeSelect.setAttribute('data-type', 'jobtype');
  categorySelect.setAttribute('data-type', 'category');

  function updateFilterStyle(select, type) {
    const styles = FILTER_STYLES[type];
    if (select.value && select.value !== select.options[0].text) {
      select.className = `border rounded-md px-3 py-2 ${styles.active}`;
    } else {
      select.className = `border rounded-md px-3 py-2 ${styles.hover}`;
    }
  }

  function getFilterValue(select, defaultText) {
    const val = select.value;
    return (val && val !== select.options[0].text) ? val : '';
  }

  function renderJobTags(tags) {
    if (!tags) return '';
    
    const tagElements = [];
    
    if (tags.location) {
      tagElements.push(`
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer hover:bg-blue-200" 
              onclick="setSelectValue('location', '${tags.location}')">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          ${tags.location}
        </span>
      `);
    }
    
    if (tags.jobtype) {
      tagElements.push(`
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200"
              onclick="setSelectValue('jobtype', '${tags.jobtype}')">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          ${tags.jobtype}
        </span>
      `);
    }
    
    if (tags.category) {
      tagElements.push(`
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 cursor-pointer hover:bg-purple-200"
              onclick="setSelectValue('category', '${tags.category}')">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
          </svg>
          ${tags.category}
        </span>
      `);
    }
    
    return tagElements.length ? `
      <div class="flex flex-wrap gap-2 mt-2">
        ${tagElements.join('')}
      </div>
    ` : '';
  }

  function renderJobs(jobsArr, append = false) {
    if (!append) jobsList.innerHTML = '';
    if (jobsArr.length === 0 && !append) {
      jobsList.innerHTML = '<li class="text-gray-400">No jobs found.</li>';
      return;
    }
    
    jobsArr.forEach(job => {
      const li = document.createElement('li');
      li.className = 'bg-white border border-indigo-100 p-4 rounded-md shadow-sm scraped-job-item';
      
      let closingHtml = '';
      if (job.closing_in || job.closing_date) {
        closingHtml = `
          <div class="text-red-600 font-medium text-sm mt-2">
            ${job.closing_in ? job.closing_in : ''}
            ${job.closing_in && job.closing_date ? ' • ' : ''}
            ${job.closing_date ? job.closing_date : ''}
          </div>
        `;
      }
      
      li.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-semibold">${job.title}</span>
          <div class="flex items-center gap-2">
            ${job.posted_date && job.posted_date !== 'n/a' ? `<span class="text-gray-400 text-xs">Posted: ${job.posted_date}</span>` : ''}
            <button class="save-job-btn inline-flex items-center px-2.5 py-1.5 border border-indigo-500 text-xs font-medium rounded text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
              </svg>
              Save Job
            </button>
          </div>
        </div>
        ${job.company ? `<div class="text-gray-600 text-sm mt-1">Company: ${job.company}</div>` : ''}
        ${closingHtml}
        <p class="text-gray-700 mt-2">${job.ai_summary}</p>
        ${renderJobTags(job.tags)}
        <a href="${job.link}" target="_blank" class="text-indigo-600 hover:underline text-xs mt-2 inline-block">View Job</a>
      `;

      // Add click event listener to the save button
      const saveButton = li.querySelector('.save-job-btn');
      saveButton.addEventListener('click', () => saveJob(job));
      
      jobsList.appendChild(li);
    });
  }

  function addJobLive(job) {
    const li = document.createElement('li');
    li.className = 'bg-white border border-indigo-100 p-4 rounded-md shadow-sm scraped-job-item';
    
    let closingHtml = '';
    if (job.closing_in || job.closing_date) {
      closingHtml = `
        <div class="text-red-600 font-medium text-sm mt-2">
          ${job.closing_in ? job.closing_in : ''}
          ${job.closing_in && job.closing_date ? ' • ' : ''}
          ${job.closing_date ? job.closing_date : ''}
        </div>
      `;
    }
    
    li.innerHTML = `
      <div class="flex justify-between items-center">
        <span class="font-semibold">${job.title}</span>
        <div class="flex items-center gap-2">
          ${job.posted_date && job.posted_date !== 'n/a' ? `<span class="text-gray-400 text-xs">Posted: ${job.posted_date}</span>` : ''}
          <button class="save-job-btn inline-flex items-center px-2.5 py-1.5 border border-indigo-500 text-xs font-medium rounded text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
            </svg>
            Save Job
          </button>
        </div>
      </div>
      ${job.company ? `<div class="text-gray-600 text-sm mt-1">Company: ${job.company}</div>` : ''}
      ${closingHtml}
      <p class="text-gray-700 mt-2">${job.ai_summary}</p>
      ${renderJobTags(job.tags)}
      <a href="${job.link}" target="_blank" class="text-indigo-600 hover:underline text-xs mt-2 inline-block">View Job</a>
    `;

    // Add click event listener to the save button
    const saveButton = li.querySelector('.save-job-btn');
    saveButton.addEventListener('click', () => saveJob(job));
    
    jobsList.insertBefore(li, jobsList.firstChild);
  }

  function fetchJobs(reset = true) {
    if (reset) {
      currentPage = 1;
      jobs = [];
      hasMore = true;
      jobsList.innerHTML = '<li class="text-gray-400">Loading...</li>';
    }

    const params = new URLSearchParams({
      search: searchInput.value.trim(),
      location: getFilterValue(locationSelect, 'Location'),
      type: getFilterValue(typeSelect, 'Opportunity Type'),
      category: getFilterValue(categorySelect, 'Category'),
      offset: (currentPage - 1) * PAGE_SIZE,
      limit: PAGE_SIZE
    });

    console.log('Fetching jobs with params:', params.toString());

    fetch(`/api/scraped-jobs?${params.toString()}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(data => {
        console.log('Received jobs data:', data);
        hasMore = data.has_more;
        if (reset) {
          jobs = data.jobs.slice();
          jobs.sort((a, b) => {
            // Parse closing_date as Date, nulls last
            const aDate = a.closing_date ? new Date(a.closing_date) : null;
            const bDate = b.closing_date ? new Date(b.closing_date) : null;
            if (aDate && bDate) return aDate - bDate;
            if (aDate && !bDate) return -1;
            if (!aDate && bDate) return 1;
            return 0;
          });
          renderJobs(jobs);
        } else {
          jobs = jobs.concat(data.jobs);
          jobs.sort((a, b) => {
            const aDate = a.closing_date ? new Date(a.closing_date) : null;
            const bDate = b.closing_date ? new Date(b.closing_date) : null;
            if (aDate && bDate) return aDate - bDate;
            if (aDate && !bDate) return -1;
            if (!aDate && bDate) return 1;
            return 0;
          });
          renderJobs(jobs, true);
        }
      })
      .catch(error => {
        console.error('Error fetching jobs:', error);
        jobsList.innerHTML = '<li class="text-red-400">Failed to load jobs. Please try again.</li>';
      });
  }

  // Event listeners
  searchInput.addEventListener('input', () => fetchJobs());
  searchButton.addEventListener('click', function(e) {
    e.preventDefault();
    if (isScrapingActive) return;

    const jobtype = getFilterValue(typeSelect, 'Opportunity Type').toLowerCase() || 'internships';
    const discipline = getFilterValue(categorySelect, 'Category').toLowerCase();
    const location = getFilterValue(locationSelect, 'Location').toLowerCase();
    const keyword = searchInput.value.trim();
    
    scrapingLoader.classList.remove('hidden');
    isScrapingActive = true;
    
    jobsList.innerHTML = '<li class="text-gray-400">Starting new search...</li>';
    
    fetch('/api/start-scraping', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jobtype, discipline, location, keyword })
    })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        console.log('Scraping started successfully');
      })
      .catch(err => {
        console.error('Error sending POST /api/start-scraping:', err);
        scrapingLoader.classList.add('hidden');
        isScrapingActive = false;
        jobsList.innerHTML = '<li class="text-red-400">Failed to start search. Please try again.</li>';
      });
  });

  locationSelect.addEventListener('change', () => {
    updateFilterStyle(locationSelect, 'location');
    fetchJobs();
  });
  typeSelect.addEventListener('change', () => {
    updateFilterStyle(typeSelect, 'jobtype');
    fetchJobs();
  });
  categorySelect.addEventListener('change', () => {
    updateFilterStyle(categorySelect, 'category');
    fetchJobs();
  });

  // Infinite Scroll
  jobsWindow.addEventListener('scroll', function() {
    if (jobsWindow.scrollTop + jobsWindow.clientHeight >= jobsWindow.scrollHeight - 50) {
      if (hasMore && !isScrapingActive) {
        currentPage++;
        fetchJobs(false);
      }
    }
  });

  // Listen for live job updates via SSE
  if (!!window.EventSource) {
    console.log('Opening SSE connection to /api/scraping-stream');
    const sse = new EventSource('/api/scraping-stream');
    
    sse.onmessage = function(event) {
      console.log('SSE job received:', event.data);
      try {
        const data = JSON.parse(event.data);
        
        if (data.type === 'ping') {
          console.log('Received ping from server');
          return;
        }
        
        if (data.status === 'complete') {
          console.log('Scraping complete, hiding loader');
          scrapingLoader.classList.add('hidden');
          isScrapingActive = false;
          fetchJobs();
          return;
        }
        
        addJobLive(data);
        
      } catch (error) {
        console.error('Error processing SSE message:', error);
      }
    };
    
    sse.onerror = function(error) {
      console.error('SSE connection error:', error);
      scrapingLoader.classList.add('hidden');
      isScrapingActive = false;
    };
  }

  // Resume upload drag-and-drop and file name display
  const dropArea = document.getElementById('resume-drop-area');
  const fileInput = document.getElementById('resume-input');
  const fileNameSpan = document.getElementById('resume-filename');

  if (dropArea && fileInput) {
    dropArea.addEventListener('click', function(e) {
      if (e.target === fileInput) return;
      fileInput.click();
    });

    fileInput.addEventListener('change', function() {
      if (fileInput.files.length > 0) {
        fileNameSpan.textContent = fileInput.files[0].name;
      } else {
        fileNameSpan.textContent = '';
      }
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.add('border-indigo-400', 'bg-indigo-50');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.remove('border-indigo-400', 'bg-indigo-50');
      });
    });

    dropArea.addEventListener('drop', e => {
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        fileNameSpan.textContent = fileInput.files[0].name;
      }
    });
  }

  // Get the reset filters button
  const resetFiltersBtn = document.getElementById('reset-filters');

  // Function to reset all filters
  function resetFilters() {
    // Reset all select elements to their first option
    locationSelect.selectedIndex = 0;
    typeSelect.selectedIndex = 0;
    categorySelect.selectedIndex = 0;
    
    // Reset the search input
    searchInput.value = '';
    
    // Reset the styles
    updateFilterStyle(locationSelect, 'location');
    updateFilterStyle(typeSelect, 'jobtype');
    updateFilterStyle(categorySelect, 'category');
    
    // Fetch jobs with reset filters
    fetchJobs();
  }

  // Add click event listener to reset button
  resetFiltersBtn.addEventListener('click', resetFilters);

  // Initialize page styles and fetch initial jobs
  updateFilterStyle(locationSelect, 'location');
  updateFilterStyle(typeSelect, 'jobtype');
  updateFilterStyle(categorySelect, 'category');
  fetchJobs();
});
</script>
{% endblock %}

