{% extends "base.html" %}
{% set active_page = "comms" %}

{% block title %}Career Climb Arena{% endblock %}

{% block content %}
<header class="px-6 py-4 bg-indigo-100 border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-xl font-semibold text-indigo-900">Career Climb Arena</h1>
</header>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="px-6 py-2">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} bg-{{ 'red' if category == 'error' else 'green' }}-100 border border-{{ 'red' if category == 'error' else 'green' }}-400 text-{{ 'red' if category == 'error' else 'green' }}-700 px-4 py-3 rounded relative mb-2" role="alert">
          <span class="block sm:inline">{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<main class="flex-1 p-6 grid grid-cols-1 lg:grid-cols-4 gap-6 overflow-y-auto">

  <!-- Friends Management -->
  <section class="bg-white border border-gray-200 p-6 shadow rounded-lg col-span-1">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Friends</h2>
    <form action="{{ url_for('add_friend') }}" method="POST" class="flex flex-col gap-2 mb-4">
      <input type="email" name="email" placeholder="Add Friend by Email" class="border rounded px-3 py-2 text-sm" required />
      <button type="submit" class="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700">Add Friend</button>
    </form>
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Your Friends</h3>
    <ul class="text-sm space-y-2">
      {% for friend in current_user.friends %}
        <li>👤 {{ friend.name }}</li>
      {% endfor %}
    </ul>
  </section>

  <!-- Leaderboard -->
  <section class="bg-white border border-gray-200 p-6 shadow rounded-lg col-span-1 lg:col-span-1">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Leaderboard</h2>
    <ul class="space-y-3 text-sm">
      {% for entry in leaderboard_data %}
        <li class="{% if entry.is_current_user %}bg-indigo-50{% else %}bg-gray-50{% endif %} px-4 py-3 rounded-md flex justify-between">
          <span>
            {% if entry.rank == 1 %}🏆{% elif entry.rank == 2 %}🥈{% elif entry.rank == 3 %}🥉{% else %}{{ entry.rank }}.{% endif %}
            <strong>{% if entry.is_current_user %}You{% else %}{{ entry.name }}{% endif %}</strong> — {{ entry.apps_count }} apps
          </span>
        </li>
      {% endfor %}
      {% if not leaderboard_data %}
        <li class="text-gray-400">No data available yet.</li>
      {% endif %}
    </ul>
  </section>

  <!-- Shared Applications -->
  <section class="bg-white border border-gray-200 p-6 shadow rounded-lg col-span-2 lg:col-span-2">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Shared Applications</h2>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-4">
      <input type="text" placeholder="Search Company" class="border rounded px-3 py-2 text-sm flex-1" />
      <select class="border rounded px-3 py-2 text-sm">
        <option>Filter by Job Type</option>
        <option>Internship</option>
        <option>Full-Time</option>
      </select>
      <select class="border rounded px-3 py-2 text-sm">
        <option>Sort by Date</option>
        <option>Newest</option>
        <option>Oldest</option>
      </select>
    </div>

    <!-- Shared Apps List -->
    <ul class="space-y-3" id="shared-apps-list">
      {% if shared_apps %}
        {% for app in shared_apps %}
          <li class="border p-4 rounded hover:bg-gray-50 flex justify-between items-center">
            <div>
              <p class="font-semibold">{{ app.company }} - {{ app.title }}</p>
              <p class="text-gray-500 text-sm">Shared by {{ app.owner.name }} | {{ app.date_applied.strftime('%Y-%m-%d') if app.date_applied else 'Date not specified' }}</p>
            </div>
            <button class="save-app-btn bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1 rounded" data-app-id="{{ app.id }}">Save</button>
          </li>
        {% endfor %}
      {% else %}
        <li class="text-gray-400 text-center py-4">No applications have been shared with you yet.</li>
      {% endif %}
    </ul>
  </section>

  <!-- Career Stats Chart -->
  <section class="col-span-4 bg-white border border-gray-200 p-6 shadow rounded-lg">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Career Stats</h2>
    <canvas id="comparisonChart" height="100"></canvas>
  </section>

</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if chart_data %}
<script>
  const chartData = JSON.parse('{{ chart_data|tojson|safe }}');

  new Chart(document.getElementById('comparisonChart'), {
    type: 'bar',
    data: chartData,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const sharedAppsList = document.getElementById('shared-apps-list');
  if (sharedAppsList) {
    sharedAppsList.addEventListener('click', function (e) {
      if (e.target.classList.contains('save-app-btn')) {
        const appId = e.target.getAttribute('data-app-id');
        saveApplication(appId);
      }
    });
  }
});

function saveApplication(appId) {
  fetch(`/save-shared-application/${appId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Application saved to your tracker!');
      } else {
        alert(data.error || 'Failed to save application');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to save application');
    });
}
</script>
{% endblock %}
