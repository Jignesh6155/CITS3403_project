{% extends "base.html" %}
{% set active_page = "comms" %}

{% block title %}Friends{% endblock %}

{% block content %}
<header class="px-6 py-4 bg-indigo-100 border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-xl font-semibold text-indigo-900">Friends</h1>
</header>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="px-6 py-2">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} bg-{{ 'red' if category == 'error' else 'green' }}-100 border border-{{ 'red' if category == 'error' else 'green' }}-400 text-{{ 'red' if category == 'error' else 'green' }}-700 px-4 py-3 rounded relative mb-2" role="alert">
          <span class="block sm:inline">{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<main class="flex-1 p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto">

<!-- Friends Management -->
<section class="bg-white border border-gray-200 p-6 shadow rounded-lg col-span-1">
  <h2 class="text-lg font-semibold text-gray-800 mb-4">Friends</h2>
  
  <!-- Friend Request Form -->
  <form action="{{ url_for('send_friend_request') }}" method="POST" class="flex flex-col gap-2 mb-4">
    <input type="email" name="email" placeholder="Add Friend by Email" class="border rounded px-3 py-2 text-sm" required />
    <button type="submit" class="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700">Send Request</button>
  </form>
  
  <!-- Pending Friend Requests -->
  <h3 class="text-sm font-semibold text-gray-700 mb-2">Pending Requests</h3>
  <ul class="text-sm space-y-2 mb-4">
    {% for request in current_user.received_requests %}
      {% if request.status == 'pending' %}
        <li class="flex items-center justify-between p-2 bg-indigo-50 rounded">
          <span>üë§ {{ request.sender.name }}</span>
          <div class="flex gap-2">
            <form action="{{ url_for('handle_friend_request', request_id=request.id) }}" method="POST" class="inline">
              <input type="hidden" name="action" value="accept">
              <button type="submit" class="bg-green-500 text-white text-xs rounded px-2 py-1 hover:bg-green-600">Accept</button>
            </form>
            <form action="{{ url_for('handle_friend_request', request_id=request.id) }}" method="POST" class="inline">
              <input type="hidden" name="action" value="reject">
              <button type="submit" class="bg-red-500 text-white text-xs rounded px-2 py-1 hover:bg-red-600">Reject</button>
            </form>
          </div>
        </li>
      {% endif %}
    {% endfor %}
    {% if not current_user.received_requests.filter_by(status='pending').all() %}
      <li class="text-gray-400">No pending requests</li>
    {% endif %}
  </ul>
  
  <!-- Friends List -->
  <h3 class="text-sm font-semibold text-gray-700 mb-2">Your Friends</h3>
  <ul class="text-sm space-y-2">
    {% for friend in current_user.friends %}
      <li class="p-2 hover:bg-gray-50 rounded flex items-center">
        <i data-lucide="user" class="w-4 h-4 text-indigo-500 mr-2"></i>
        {{ friend.name }}
      </li>
    {% endfor %}
    {% if not current_user.friends.all() %}
      <li class="text-gray-400">No friends yet</li>
    {% endif %}
  </ul>
</section>

  <!-- Leaderboard -->
  <section class="bg-white border border-gray-200 p-6 shadow rounded-lg col-span-1">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Application Leaderboard</h2>
    <ul class="space-y-3 text-sm">
      {% set user_friends = user.friends.all() %}
      {% set all_users = [user] + user_friends %}
      
      {% set leaderboard = [] %}
      {% for u in all_users %}
        {% set application_count = u.job_applications|length %}
        {% set temp = leaderboard.append({'name': u.name, 'apps_count': application_count, 'is_current_user': u.id == user.id}) %}
      {% endfor %}
      
      {% set sorted_leaderboard = leaderboard|sort(attribute='apps_count', reverse=true) %}
      
      {% for entry in sorted_leaderboard %}
        <li class="{% if entry.is_current_user %}bg-indigo-50{% else %}bg-gray-50{% endif %} px-4 py-3 rounded-md flex justify-between">
          <span>
            {% if loop.index == 1 %}üèÜ{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}.{% endif %}
            <strong>{% if entry.is_current_user %}You{% else %}{{ entry.name }}{% endif %}</strong>
          </span>
          <span class="font-medium">{{ entry.apps_count }} applications</span>
        </li>
      {% endfor %}
      
      {% if not sorted_leaderboard %}
        <li class="text-gray-400 text-center py-4">No data available yet.</li>
      {% endif %}
    </ul>
  </section>

  <!-- Shared Applications -->
  <section class="bg-white border border-gray-200 p-6 shadow rounded-lg col-span-1 flex flex-col h-full">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Shared Applications</h2>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-4 flex-shrink-0">
      <input type="text" id="job-search" placeholder="Search Job Title" class="border rounded px-3 py-2 text-sm flex-1" onkeyup="filterApplications()" />
      <select id="job-type-filter" class="border rounded px-3 py-2 text-sm" onchange="filterApplications()">
        <option value="">Filter by Job Type</option>
        <option value="Internship">Internship</option>
        <option value="Graduate-Job">Graduate Job</option>
        <option value="Scholarship">Scholarship</option>
        <option value="Clerkship">Clerkship</option>
      </select>
      <select id="date-filter" class="border rounded px-3 py-2 text-sm" onchange="filterApplications()">
        <option value="">Sort by Date</option>
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
    </div>

    <!-- Tabs -->
    <div class="flex border-b border-gray-200 mb-4 flex-shrink-0">
      <button id="active-tab" class="tab-btn px-4 py-2 border-b-2 border-indigo-500 text-indigo-600 font-medium" onclick="switchTab('active')">Active</button>
      <button id="archived-tab" class="tab-btn px-4 py-2 text-gray-600 hover:text-gray-800" onclick="switchTab('archived')">Archived</button>
    </div>

    <!-- Shared Apps List Container -->
    <div class="overflow-y-auto flex-1 border border-gray-200 rounded mb-4">
      <!-- Active Applications List -->
      <ul class="space-y-3 p-4 tab-content h-full" id="active-applications">
        {% set active_apps = [] %}
        {% set archived_apps = [] %}

        {% for app in shared_apps %}
          {% if app_statuses[app.id] == 'active' %}
            {% set temp = active_apps.append(app) %}
          {% else %}
            {% set temp = archived_apps.append(app) %}
          {% endif %}
        {% endfor %}
        
        {% if active_apps %}
          {% for app in active_apps %}
            <li class="app-item border p-4 rounded hover:bg-gray-50 flex justify-between items-center" 
                id="shared-app-{{ app.id }}"
                data-title="{{ app.title|lower }}" 
                data-date="{{ app.date_applied.strftime('%Y-%m-%d') if app.date_applied else '' }}"
                data-job-type="{{ app.job_type|lower if app.job_type else '' }}">
              <div>
                <p class="font-semibold">{{ app.company }} - {{ app.title }}</p>
                <p class="text-gray-500 text-sm">Shared by {{ app.user.name }} | {{ app.date_applied.strftime('%Y-%m-%d') if app.date_applied else 'Date not specified' }}</p>
                {% if app.location or app.job_type %}
                  <p class="text-gray-500 text-xs mt-1">
                    {% if app.location %}üìç {{ app.location }}{% endif %}
                    {% if app.location and app.job_type %} ‚Ä¢ {% endif %}
                    {% if app.job_type %}üíº {{ app.job_type }}{% endif %}
                  </p>
                {% endif %}
                {% if app.closing_date %}
                  <p class="text-red-600 text-xs mt-1">Closes: {{ app.closing_date.strftime('%d %b %Y') }}</p>
                {% endif %}
              </div>
              <button onclick="saveApplication('{{ app.id }}')" 
                      class="save-app-btn bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1 rounded transition-colors duration-200"
                      id="save-btn-{{ app.id }}">
                Save to Tracker
              </button>
            </li>
          {% endfor %}
        {% else %}
          <li class="empty-message text-gray-400 text-center py-4">No active shared applications.</li>
        {% endif %}
      </ul>
      
      <!-- Archived Applications List -->
      <ul class="space-y-3 p-4 tab-content hidden h-full" id="archived-applications">
        {% if archived_apps %}
          {% for app in archived_apps %}
            <li class="app-item border p-4 rounded hover:bg-gray-50"
                data-title="{{ app.title|lower }}" 
                data-date="{{ app.date_applied.strftime('%Y-%m-%d') if app.date_applied else '' }}"
                data-job-type="{{ app.job_type|lower if app.job_type else '' }}">
              <div>
                <p class="font-semibold">{{ app.company }} - {{ app.title }}</p>
                <p class="text-gray-500 text-sm">Shared by {{ app.user.name }} | {{ app.date_applied.strftime('%Y-%m-%d') if app.date_applied else 'Date not specified' }}</p>
                {% if app.location or app.job_type %}
                  <p class="text-gray-500 text-xs mt-1">
                    {% if app.location %}üìç {{ app.location }}{% endif %}
                    {% if app.location and app.job_type %} ‚Ä¢ {% endif %}
                    {% if app.job_type %}üíº {{ app.job_type }}{% endif %}
                  </p>
                {% endif %}
                {% if app.closing_date %}
                  <p class="text-red-600 text-xs mt-1">Closes: {{ app.closing_date.strftime('%d %b %Y') }}</p>
                {% endif %}
                <span class="inline-block mt-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">Saved to your tracker</span>
              </div>
            </li>
          {% endfor %}
        {% else %}
          <li class="empty-message text-gray-400 text-center py-4">No archived applications.</li>
        {% endif %}
      </ul>
    </div>
  </section>

</main>

<script>
// Tab switching functionality
function switchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600', 'font-medium');
    btn.classList.add('text-gray-600', 'hover:text-gray-800');
  });
  
  document.getElementById(`${tabName}-tab`).classList.remove('text-gray-600', 'hover:text-gray-800');
  document.getElementById(`${tabName}-tab`).classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600', 'font-medium');
  
  // Hide all tab content and show the selected one
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(`${tabName}-applications`).classList.remove('hidden');
  
  // Run filtering on the visible tab
  filterApplications();
}

// Filter applications based on search, job type, and date sorting
function filterApplications() {
  const searchTerm = document.getElementById('job-search').value.toLowerCase();
  const jobTypeFilter = document.getElementById('job-type-filter').value.toLowerCase();
  const dateFilter = document.getElementById('date-filter').value;
  
  // Determine which tab is active
  const activeTabId = document.querySelector('.tab-btn.border-indigo-500').id.replace('-tab', '');
  const applicationsContainer = document.getElementById(`${activeTabId}-applications`);
  const applications = Array.from(applicationsContainer.querySelectorAll('.app-item'));
  
  // If no applications, exit early
  if (applications.length === 0) return;
  
  // First, filter by search term and job type
  let filteredApps = applications.filter(app => {
    const jobTitle = app.getAttribute('data-title') || '';
    const jobType = app.getAttribute('data-job-type') || '';
    
    const matchesSearch = !searchTerm || jobTitle.includes(searchTerm);
    const matchesJobType = !jobTypeFilter || jobType.includes(jobTypeFilter.toLowerCase());
    
    return matchesSearch && matchesJobType;
  });
  
  // Then sort by date if a sort option is selected
  if (dateFilter) {
    filteredApps.sort((a, b) => {
      const dateA = a.getAttribute('data-date') || '';
      const dateB = b.getAttribute('data-date') || '';
      
      if (dateFilter === 'newest') {
        return dateB.localeCompare(dateA); // Newest first (descending)
      } else {
        return dateA.localeCompare(dateB); // Oldest first (ascending)
      }
    });
  }
  
  // Hide all applications first
  applications.forEach(app => {
    app.classList.add('hidden');
  });
  
  // Show filtered and sorted applications
  filteredApps.forEach(app => {
    app.classList.remove('hidden');
  });
  
  // Show/hide empty message
  const emptyMessage = applicationsContainer.querySelector('.empty-message');
  if (emptyMessage) {
    if (filteredApps.length === 0) {
      emptyMessage.textContent = 'No applications match your filters.';
      emptyMessage.classList.remove('hidden');
    } else {
      emptyMessage.classList.add('hidden');
    }
  }
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-opacity duration-300`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function saveApplication(appId) {
  const button = document.getElementById(`save-btn-${appId}`);
  button.disabled = true;
  button.textContent = 'Saving...';
  button.classList.add('opacity-75');

  fetch(`/save-shared-application/${appId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Move the item from active to archived tab
      const appItem = document.getElementById(`shared-app-${appId}`);
      const archivedList = document.getElementById('archived-applications');
      
      // Clone the app item for the archived section
      const archivedItem = appItem.cloneNode(true);
      
      // Remove the save button and add "Saved" label
      const buttonContainer = archivedItem.querySelector('.save-app-btn').parentNode;
      archivedItem.querySelector('.save-app-btn').remove();
      
      // Add saved indicator
      const savedIndicator = document.createElement('span');
      savedIndicator.className = 'inline-block mt-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded';
      savedIndicator.textContent = 'Saved to your tracker';
      archivedItem.querySelector('div').appendChild(savedIndicator);
      
      // Add to archived list
      archivedList.appendChild(archivedItem);
      
      // Remove from active list
      appItem.remove();
      
      // Check if active list is empty
      const activeList = document.getElementById('active-applications');
      if (activeList.querySelectorAll('.app-item').length === 0) {
        const emptyMessage = document.createElement('li');
        emptyMessage.className = 'empty-message text-gray-400 text-center py-4';
        emptyMessage.textContent = 'No active shared applications.';
        activeList.appendChild(emptyMessage);
      }
      
      // Show toast
      showToast('Application saved to your tracker!', 'success');
      
      // Reapply filters
      filterApplications();
    } else {
      throw new Error(data.error || 'Failed to save application');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    button.disabled = false;
    button.textContent = 'Save to Tracker';
    button.classList.remove('opacity-75');
    showToast(error.message || 'Failed to save application', 'error');
  });
}

// Initialize when document is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Initialize the active tab
  switchTab('active');
});
</script>
{% endblock %}